name: Sync OpenWrt snapshots to Main

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹

on:
  push:
    paths:
      - '.github/workflows/main.yml'
  schedule:
    - cron: 0 */12 * * *  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. å…‹éš† OpenWrt å®˜æ–¹ä»“åº“çš„ snapshots åˆ†æ”¯
      - name: Clone OpenWrt Repository
        run: |
          git clone --branch main https://github.com/openwrt/openwrt.git
          cd openwrt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 2. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½ çš„ä»“åº“ï¼‰
      - name: Clone Your Repository
        env:
          PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          git clone https://x-access-token:${PAT}@github.com/wixxm/OpenWrt-snapshots.git target_repo

      # 3. å¤‡ä»½ .github æ–‡ä»¶å¤¹å’Œéœ€è¦ä¿ç•™çš„æ–‡ä»¶
      - name: Backup Existing Files
        run: |
          mkdir -p backup
          # å¤‡ä»½ .github æ–‡ä»¶å¤¹
          if [ -d "target_repo/.github" ]; then
            mv target_repo/.github backup/github_backup
          fi
          # å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
          mkdir -p backup/files
          cp -r target_repo/config/Config-images.in backup/files/ || true
          cp -r target_repo/package/base-files/files/etc/banner backup/files/  || true
          cp -r target_repo/package/base-files/files/bin/config_generate backup/files/ || true
          cp -r target_repo/include/version.mk backup/files/ || true
          
      # 4. å°† OpenWrt ä»“åº“çš„å†…å®¹åŒæ­¥åˆ°ç›®æ ‡ä»“åº“
      - name: Sync OpenWrt Changes
        run: |
          rsync -av --delete --exclude='.git' --exclude='.github' openwrt/ target_repo/

      # 5. æ¢å¤å¤‡ä»½çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
      - name: Restore Backup Files
        run: |
          # æ¢å¤ .github æ–‡ä»¶å¤¹
          if [ -d "backup/github_backup" ]; then
            mv backup/github_backup target_repo/.github
          fi
          # æ¢å¤å…¶ä»–æ–‡ä»¶
          cp -r backup/files/Config-images.in target_repo/config/ || true
          cp -r backup/files/banner target_repo/package/base-files/files/etc/ || true
          cp -r backup/files/config_generate target_repo/package/base-files/files/bin/ || true
          cp -r backup/files/version.mk target_repo/include/ || true

      # 6. æ˜¾å¼é…ç½® Git ç”¨æˆ·ä¿¡æ¯å¹¶æäº¤æ›´æ”¹
      - name: Commit and Push Changes
        env:
          PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          cd target_repo
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name "wixxm"  # ä¿®æ”¹ä¸ºæ‚¨çš„ç”¨æˆ·å
          git config user.email "girhub@github.com"  # ä¿®æ”¹ä¸ºæ‚¨çš„é‚®ç®±

          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·
          export TZ="Asia/Shanghai"

          # è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")

          # æäº¤å¹¶å¼ºåˆ¶æ¨é€æ›´æ”¹
          git add .
          git commit -m "ğŸ… Sync OpneWrt-snapshots - $timestamp" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹å¯æäº¤"
          git push origin HEAD:main --force
